#!/bin/bash

# set -e: å¦‚æœä»»ä½•å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œè„šæœ¬å°†ç«‹å³é€€å‡ºï¼Œä¿è¯äº†æ“ä½œçš„åŸå­æ€§ã€‚
set -e

# ==================== é…ç½®åŒº ====================

# ä½ çš„ kind é›†ç¾¤åç§°ï¼Œè¯·ç¡®ä¿å’Œ kind-config.yaml ä¸­çš„ name ä¸€è‡´ã€‚
CLUSTER_NAME="dev-cluster"

# ä½ éœ€è¦æ¨é€åˆ°é›†ç¾¤çš„é•œåƒåˆ—è¡¨ã€‚
# è¯·å°†ä½ çš„å¾®æœåŠ¡ã€åŸºç¡€é•œåƒç­‰éƒ½æ·»åŠ åˆ°è¿™é‡Œã€‚
IMAGES=(
  "user-service:latest"
  "video-service:latest"
)

# ==================== è„šæœ¬æ‰§è¡ŒåŒº ====================

# 1. æ£€æŸ¥ kind é›†ç¾¤æ˜¯å¦å­˜åœ¨ä¸”åœ¨è¿è¡Œä¸­
echo "ğŸ” æ­£åœ¨æ£€æŸ¥ kind é›†ç¾¤ '${CLUSTER_NAME}' æ˜¯å¦åœ¨è¿è¡Œ..."
if ! kind get clusters | grep -q "^${CLUSTER_NAME}$"; then
  echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°åä¸º '${CLUSTER_NAME}' çš„ kind é›†ç¾¤ã€‚"
  echo "   è¯·å…ˆä½¿ç”¨ 'kind create cluster --name ${CLUSTER_NAME} --config ...' å‘½ä»¤åˆ›å»ºé›†ç¾¤ã€‚"
  exit 1
fi
echo "âœ… é›†ç¾¤ '${CLUSTER_NAME}' å·²å°±ç»ªã€‚"
echo ""


# 2. éå†é•œåƒåˆ—è¡¨å¹¶æ‰§è¡Œæ¨é€å‘½ä»¤
echo "ğŸš€ å¼€å§‹å°†é•œåƒæ¨é€åˆ°é›†ç¾¤ '${CLUSTER_NAME}'..."
echo "--------------------------------------------------------"

for img in "${IMAGES[@]}"; do
  echo "ğŸš¢ æ­£åœ¨æ¨é€é•œåƒ: ${img} ..."

  # æ£€æŸ¥é•œåƒæ˜¯å¦åœ¨æœ¬åœ°å­˜åœ¨
  if ! docker image inspect "${img}" &> /dev/null; then
    echo "âš ï¸  è­¦å‘Š: é•œåƒ '${img}' åœ¨æœ¬åœ°ä¸å­˜åœ¨ï¼Œæ­£åœ¨å°è¯•æ‹‰å–..."
    docker pull "${img}"
  fi

  # æ‰§è¡Œ kind load å‘½ä»¤
  kind load docker-image "${img}" --name "${CLUSTER_NAME}"
  echo "âœ… é•œåƒ '${img}' æ¨é€æˆåŠŸã€‚"
  echo "--------------------------------------------------------"
done

echo "ğŸ‰ æ‰€æœ‰é•œåƒå·²æˆåŠŸæ¨é€åˆ°é›†ç¾¤ï¼"